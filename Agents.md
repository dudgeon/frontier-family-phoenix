# ðŸ›¡ï¸ Agents.md â€” Guardâ€‘rails & Conventions for **frontierâ€‘familyâ€‘phoenix**

> Last updatedÂ 2025â€‘05â€‘29

## 1Â Â Purpose

This repo relies on **OpenAIÂ Codex** and other AI agents to automate feature work.
**Agents.md** defines the rules every agent must follow when it creates or updates:

* code & SQL migrations
* tests & documentation
* CI / CD configuration

A PR generated by an agent **must satisfy these rules** or CI will block the merge.

---

## 2Â Â Repository anatomy (highâ€‘level)

| Path                   | Description                                  |
| ---------------------- | -------------------------------------------- |
| `apps/web/`            | ExpoÂ +Â Reactâ€‘Nativeâ€‘Web entry                |
| `apps/native/`         | Future iOS / Android entry                   |
| `functions/`           | Netlify Functions & Edge Functions (NodeÂ 20) |
| `packages/db/`         | Supabase typed client, SQL helpers           |
| `packages/testing/`    | Shared Vitest / Playwright utils & seeds     |
| `supabase/migrations/` | Incremental SQL migrations                   |
| `.github/workflows/`   | CI + branchâ€‘DB orchestration                 |

---

## 3Â Â Golden rules for AIâ€‘generated PRs

1. **Testâ€‘first or testâ€‘adjacent** â€“ if you change behaviour, you must change or add tests.
2. **Never decrease coverage** â€“ global â‰¥Â 80â€¯%, and each touched file must stay â‰¥Â 80â€¯%.
3. **Do not weaken lint rules** â€“ disabling or deleting an ESLint rule fails CI.
4. **RLS is sacrosanct** â€“ migrations touching core tables require matching integration tests.
5. **Hardâ€‘delete must log** â€“ use helpers in `packages/db/src/deletion.ts` to write `deletion_audit` rows.
6. **Migrations must be idempotent** â€“ CI replays them on every branch database.
7. **Streaming responses** â€“ Netlify Functions must return `ReadableStream`s and flush â‰¤Â 100â€¯ms.
8. **No secret literals** â€“ always read from `process.env.*`.

---

## 4Â Â Workflow templates

### 4.1Â Â Create a new Netlify Function

1. Add file `functions/<feature>/handler.ts`.
2. Run `npm run gen:test functions/<feature>/handler.ts` to scaffold a matching test.
3. Implement the function **and** finish the test until it passes.
4. Ensure coverage remains â‰¥Â 80â€¯%.
5. Commit & open PR.

### 4.2Â Â Update the database schema

1. Add SQL file in `supabase/migrations/` (increment the number).
2. Include/adjust **RLS** in the same file.
3. Regenerate TypeScript types:

   ```bash
   npx supabase@latest gen types typescript --local \
     --project-id "$SUPABASE_PROJECT_REF" --schema public \
     > packages/db/src/types.ts
   ```
4. Add an integration test proving the new policy.
5. Update seed data if required.

---

## 5Â Â Test expectations

| Layer       | Location               | Tool               |
| ----------- | ---------------------- | ------------------ |
| Unit        | `tests/unit/**`        | **Vitest**         |
| Integration | `tests/integration/**` | VitestÂ +Â Supertest |
| Endâ€‘toâ€‘End  | `tests/e2e/**`         | **Playwright**     |

CI merges LCOV and enforces coverage â‰¥Â 80â€¯%.

---

## 6Â Â Coding style & lint

* ESLint config lives in `.eslintrc.cjs` (ReactÂ +Â TSÂ +Â Prettier).
* Prettier runs via `lintâ€‘staged` on preâ€‘commit.
* Absolute import alias `@/*` is allowed (see `tsconfig.json`).

---

## 7Â Â Security guardâ€‘rails

| Concern                  | Enforcement                                         |
| ------------------------ | --------------------------------------------------- |
| Secrets exposure         | ESLint `no-literal-secret` custom rule              |
| SQL injection            | Use parameterised helpers in `packages/db`          |
| RLS regression           | Tests in `tests/integration/security/*.test.ts`     |
| Deletion irreversibility | Hardâ€‘delete helpers must append to `deletion_audit` |

---

## 8Â Â Prompt snippet for Codex contributors

> **When you, Codex, commit to this repo, you must:**
>
> 1. Run `npm run gen:test <changed-path>` for each new function/component.
> 2. Fill **all** TODOs in generated tests until they pass.
> 3. Keep coverage â‰¥Â 80â€¯% fileâ€‘level **and** global.
> 4. Never commit real secretsÂ â€” use `process.env.*`.
> 5. If you modify migrations, regenerate DB types.

---

**End of file**
