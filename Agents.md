# 🛡️ Agents.md — Guard‑rails & Conventions for **frontier‑family‑phoenix**

> Last updated 2025‑05‑29

## 1  Purpose

This repo relies on **OpenAI Codex** and other AI agents to automate feature work.
**Agents.md** defines the rules every agent must follow when it creates or updates:

* code & SQL migrations
* tests & documentation
* CI / CD configuration

A PR generated by an agent **must satisfy these rules** or CI will block the merge.

---

## 2  Repository anatomy (high‑level)

| Path                   | Description                                  |
| ---------------------- | -------------------------------------------- |
| `apps/web/`            | Expo + React‑Native‑Web entry                |
| `apps/native/`         | Future iOS / Android entry                   |
| `functions/`           | Netlify Functions & Edge Functions (Node 20) |
| `packages/db/`         | Supabase typed client, SQL helpers           |
| `packages/testing/`    | Shared Vitest / Playwright utils & seeds     |
| `supabase/migrations/` | Incremental SQL migrations                   |
| `.github/workflows/`   | CI + branch‑DB orchestration                 |

---

## 3  Golden rules for AI‑generated PRs

1. **Test‑first or test‑adjacent** – if you change behaviour, you must change or add tests.
2. **Never decrease coverage** – global ≥ 80 %, and each touched file must stay ≥ 80 %.
3. **Do not weaken lint rules** – disabling or deleting an ESLint rule fails CI.
4. **RLS is sacrosanct** – migrations touching core tables require matching integration tests.
5. **Hard‑delete must log** – use helpers in `packages/db/src/deletion.ts` to write `deletion_audit` rows.
6. **Migrations must be idempotent** – CI replays them on every branch database.
7. **Streaming responses** – Netlify Functions must return `ReadableStream`s and flush ≤ 100 ms.
8. **No secret literals** – always read from `process.env.*`.

---

## 4  Workflow templates

### 4.1  Create a new Netlify Function

1. Add file `functions/<feature>/handler.ts`.
2. Run `npm run gen:test functions/<feature>/handler.ts` to scaffold a matching test.
3. Implement the function **and** finish the test until it passes.
4. Ensure coverage remains ≥ 80 %.
5. Commit & open PR.

### 4.2  Update the database schema

1. Add SQL file in `supabase/migrations/` (increment the number).
2. Include/adjust **RLS** in the same file.
3. Regenerate TypeScript types:

   ```bash
   npx supabase@latest gen types typescript --local \
     --project-id "$SUPABASE_PROJECT_REF" --schema public \
     > packages/db/src/types.ts
   ```
4. Add an integration test proving the new policy.
5. Update seed data if required.

---

## 5  Test expectations

| Layer       | Location               | Tool               |
| ----------- | ---------------------- | ------------------ |
| Unit        | `tests/unit/**`        | **Vitest**         |
| Integration | `tests/integration/**` | Vitest + Supertest |
| End‑to‑End  | `tests/e2e/**`         | **Playwright**     |

CI merges LCOV and enforces coverage ≥ 80 %.

---

## 6  Coding style & lint

* ESLint config lives in `.eslintrc.cjs` (React + TS + Prettier).
* Prettier runs via `lint‑staged` on pre‑commit.
* Absolute import alias `@/*` is allowed (see `tsconfig.json`).

---

## 7  Security guard‑rails

| Concern                  | Enforcement                                         |
| ------------------------ | --------------------------------------------------- |
| Secrets exposure         | ESLint `no-literal-secret` custom rule              |
| SQL injection            | Use parameterised helpers in `packages/db`          |
| RLS regression           | Tests in `tests/integration/security/*.test.ts`     |
| Deletion irreversibility | Hard‑delete helpers must append to `deletion_audit` |

---

## 8  Prompt snippet for Codex contributors

> **When you, Codex, commit to this repo, you must:**
>
> 1. Run `npm run gen:test <changed-path>` for each new function/component.
> 2. Fill **all** TODOs in generated tests until they pass.
> 3. Keep coverage ≥ 80 % file‑level **and** global.
> 4. Never commit real secrets — use `process.env.*`.
> 5. If you modify migrations, regenerate DB types.

---

**End of file**
